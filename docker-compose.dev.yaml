services:
  goals_backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    user: "${UID:-1000}:${GID:-1000}"
    restart: unless-stopped
    ports:
      # Default: publish backend on host port 5059 for local dev.
      # In CI (when merged with docker-compose.test.yaml), set GOALS_BACKEND_PORTS=5059
      # to publish container port 5059 on a random host port and avoid host-port conflicts.
      - "${GOALS_BACKEND_PORTS:-5059:5059}"
    volumes:
      - ./backend/:/usr/src/app
    env_file:
      - .env
    environment:
      HOST_URL: ${HOST_URL:-localhost}
      CARGO_HOME: /tmp/cargo-home
      CARGO_TARGET_DIR: /tmp/cargo-target
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_REDIRECT_URL: ${GOOGLE_REDIRECT_URL:-http://${HOST_URL:-localhost}:3030/auth/callback}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}
      VAPID_PUBLIC_KEY: ${VAPID_PUBLIC_KEY}
      VAPID_PRIVATE_KEY: ${VAPID_PRIVATE_KEY}
      VAPID_SUBJECT: ${VAPID_SUBJECT}
      NEO4J_MAX_CONNECTIONS: 10
    networks:
      - dev_network
      #    db:
      #build:
      #context: ./db
      #dockerfile: Dockerfile.dev
      #ports:
      #- "5432:5432"
      #networks:
      #- dev_network
      #volumes:
      #- goal_db:/var/lib/postgresql/data
      #restart: unless-stopped
  goals_db:
    build:
      context: ./db
      dockerfile: Dockerfile.dev
    ports:
      # Default: publish Neo4j for local dev.
      # In CI you can set these to "7474"/"7687" to publish on random host ports.
      - "${GOALS_DB_HTTP_PORTS:-7474:7474}"
      - "${GOALS_DB_BOLT_PORTS:-7687:7687}"
    volumes:
      - goal_db:/data
    networks:
      - dev_network

  goals_frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      CHOKIDAR_USEPOLLING: "true" #enable polling
      HOST_URL: ${HOST_URL:-localhost}
      REACT_APP_API_URL: "http://${HOST_URL:-localhost}:5059"
      REACT_APP_GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      REACT_APP_VAPID_PUBLIC_KEY: ${VAPID_PUBLIC_KEY}
    env_file:
      - .env
    ports:
      # Default: publish frontend on host port 3030 for local dev.
      # In CI (when merged with docker-compose.test.yaml), set GOALS_FRONTEND_PORTS=3030
      # to publish container port 3030 on a random host port and avoid host-port conflicts.
      - "${GOALS_FRONTEND_PORTS:-3030:3030}"
    restart: unless-stopped
    networks:
      - dev_network

volumes:
  goal_db:


networks:
  dev_network:
    driver: bridge
